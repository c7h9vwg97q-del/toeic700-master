<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="ui.css">
  <title>Weak Mode - TOEIC 700 Master</title>
  <style>
    #version-tag { font-size: 10px; color: var(--subtext); position: absolute; top: 10px; right: 10px; opacity: 0.7; }

    #card { min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; -webkit-tap-highlight-color: transparent; user-select: none; }
    #answer-section { margin-top: 20px; padding-top: 20px; border-top: 1px dashed #444; width: 100%; text-align: center; }

    #meaning { font-size: 1.5rem; color: var(--accent); font-weight: bold; margin-bottom: 10px; }
    #example { font-style: italic; color: var(--subtext); font-size: 0.9rem; line-height: 1.4; padding: 0 10px; }

    .btn-group { display: grid; gap: 10px; width: 100%; }
    .sub-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    button:disabled { opacity: 0.25; cursor: not-allowed; filter: grayscale(1); pointer-events: none; }

    .status-msg { text-align: center; margin-top: 50px; }

    /* å®‰å…¨ç­–: hidden ãŒ ui.css ã«ç„¡ãã¦ã‚‚å‹•ãã‚ˆã†ã«ã™ã‚‹ */
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="version-tag">WEAK MODE v3</div>

  <div class="container">
    <button class="btn-outline" style="margin-bottom: 20px; width: auto;" onclick="location.href='index.html'">â† æˆ»ã‚‹</button>

    <div id="learning-ui">
      <div class="card" id="card">
        <div id="word" class="text-large">èª­ã¿è¾¼ã¿ä¸­...</div>

        <!-- ã“ã“ãŒæœ€é‡è¦: åˆæœŸã§å¿…ãš hidden ã‚’ä»˜ã‘ã¦ãŠã -->
        <div id="answer-section" class="hidden">
          <div id="meaning"></div>
          <div id="example"></div>
        </div>

        <div id="tap-hint" style="margin-top: 20px; font-size: 12px; color: #666;">
          ã‚¿ãƒƒãƒ—ã§ç­”ãˆã‚’è¡¨ç¤º
        </div>
      </div>

      <div class="mt-20 btn-group">
        <button id="btn-known" class="btn-primary" disabled>è¦šãˆãŸ</button>
        <div class="sub-group">
          <button id="btn-unsure" class="btn-outline" disabled>æ€ªã—ã„</button>
          <button id="btn-forgot" class="btn-outline" style="color: var(--danger); border-color: var(--danger);" disabled>å¿˜ã‚ŒãŸ</button>
        </div>
      </div>

      <p id="remaining-count" style="text-align:center; font-size:12px; color:var(--subtext); margin-top:15px;"></p>
    </div>

    <div id="empty-ui" class="hidden status-msg">
      <div class="text-large">ğŸ‰ Clear!</div>
      <p>ç¾åœ¨,å¼±ç‚¹å˜èªã¯ã‚ã‚Šã¾ã›ã‚“.</p>
      <button class="btn-primary mt-20" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
    </div>
  </div>

  <script src="data.js"></script>
  <script src="srs.js"></script>

  <script>
    (() => {
      'use strict';

      let weakQueue = [];
      let current = null;
      let isRevealed = false;
      let isProcessing = false;

      const dom = {
        card: document.getElementById('card'),
        word: document.getElementById('word'),
        answer: document.getElementById('answer-section'),
        meaning: document.getElementById('meaning'),
        example: document.getElementById('example'),
        hint: document.getElementById('tap-hint'),
        remaining: document.getElementById('remaining-count'),
        learningUI: document.getElementById('learning-ui'),
        emptyUI: document.getElementById('empty-ui'),
        btnKnown: document.getElementById('btn-known'),
        btnUnsure: document.getElementById('btn-unsure'),
        btnForgot: document.getElementById('btn-forgot'),
        btns: []
      };
      dom.btns = [dom.btnKnown, dom.btnUnsure, dom.btnForgot];

      function setButtons(on) {
        dom.btns.forEach(b => b.disabled = !on);
      }

      function buildWeakQueue() {
        const stats = SRS.getStats();
        weakQueue = wordData.filter(w => {
          const s = stats[w.id];
          if (!s) return false;
          const total = (s.correct || 0) + (s.wrong || 0);
          if (total === 0) return false;
          const acc = (s.correct || 0) / total;
          return acc < 0.7;
        });

        // ä¸¦ã³ã‚’æ¯å›ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        for (let i = weakQueue.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          const tmp = weakQueue[i];
          weakQueue[i] = weakQueue[j];
          weakQueue[j] = tmp;
        }
      }

      function resetAnswerHidden() {
        // ã“ã“ãŒç­”ãˆå…ˆå‡ºã—å¯¾ç­–ã®æœ¬ä½“
        dom.answer.classList.add('hidden');
        dom.hint.classList.remove('hidden');
        setButtons(false);
        isRevealed = false;
      }

      function loadNext() {
        isProcessing = false;

        if (weakQueue.length === 0) {
          dom.learningUI.classList.add('hidden');
          dom.emptyUI.classList.remove('hidden');
          return;
        }

        current = weakQueue.shift();

        // è¡¨ç¤ºã¯å…ˆã« word ã®ã¿å‡ºã™
        dom.word.innerText = current.word;

        // ç­”ãˆã¯ hidden ã®ã¾ã¾ä¸­èº«ã ã‘æ›´æ–°
        dom.meaning.innerText = current.meaning;
        dom.example.innerText = current.example;

        resetAnswerHidden();

        dom.remaining.innerText = "æ®‹ã‚Š " + weakQueue.length + " å˜èª";
      }

      function reveal() {
        if (!current || isRevealed) return;
        isRevealed = true;
        dom.answer.classList.remove('hidden');
        dom.hint.classList.add('hidden');
        setButtons(true);
      }

      function handleAnswer(isCorrect) {
        if (isProcessing || !current || !isRevealed) return;
        isProcessing = true;

        SRS.recordResult(current.id, isCorrect);

        // ãã®å ´ã§å¼±ç‚¹åˆ¤å®šã‚’æ›´æ–°ã—ã¦æ¬¡ã¸
        buildWeakQueue();
        loadNext();
      }

      // ã‚«ãƒ¼ãƒ‰ã‚¿ãƒƒãƒ—ã§è¡¨ç¤º
      dom.card.addEventListener('click', (e) => { e.preventDefault(); reveal(); });

      // ãƒœã‚¿ãƒ³
      dom.btnKnown.addEventListener('click', () => handleAnswer(true));
      dom.btnUnsure.addEventListener('click', () => handleAnswer(false));
      dom.btnForgot.addEventListener('click', () => handleAnswer(false));

      // iOSå¯¾ç­–
      document.addEventListener('touchstart', () => {}, { passive: true });

      window.addEventListener('DOMContentLoaded', () => {
        if (typeof window.wordData === 'undefined' || typeof window.SRS === 'undefined') {
          dom.word.innerText = "èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼";
          dom.hint.classList.add('hidden');
          return;
        }
        buildWeakQueue();
        loadNext();
      });
    })();
  </script>

</body>
</html>