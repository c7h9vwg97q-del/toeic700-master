<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="stylesheet" href="ui.css">
  <title>Weak Mode - TOEIC 700 Master</title>
  <style>
    #version-tag { font-size: 10px; color: var(--subtext); position: absolute; top: 10px; right: 10px; opacity: 0.7; }
    #card { min-height: 250px; display: flex; flex-direction: column; justify-content: center; align-items: center; cursor: pointer; }
    #answer-section { margin-top: 20px; padding-top: 20px; border-top: 1px dashed #444; width: 100%; }
    #meaning { font-size: 1.5rem; color: var(--accent); font-weight: bold; margin-bottom: 10px; }
    #example { font-style: italic; color: var(--subtext); font-size: 0.9rem; }
    .btn-group { display: grid; gap: 10px; width: 100%; }
    .sub-group { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    button:disabled { opacity: 0.3; cursor: not-allowed; }
    .status-msg { text-align: center; margin-top: 50px; }
  </style>
</head>
<body>

<div id="version-tag">WEAK MODE v3</div>

<div class="container">
  <button class="btn-outline" style="margin-bottom: 20px; width: auto;" onclick="location.href='index.html'">â† æˆ»ã‚‹</button>

  <div id="learning-ui">
    <div class="card" id="card">
      <div id="word" class="text-large"></div>

      <div id="answer-section" class="hidden">
        <div id="meaning"></div>
        <div id="example"></div>
      </div>

      <div id="tap-hint" style="margin-top: 20px; font-size: 12px; color: #666;">
        ã‚¿ãƒƒãƒ—ã§ç­”ãˆã‚’è¡¨ç¤º
      </div>
    </div>

    <div class="mt-20 btn-group">
      <button id="btn-known" class="btn-primary" disabled>è¦šãˆãŸ</button>
      <div class="sub-group">
        <button id="btn-unsure" class="btn-outline" disabled>æ€ªã—ã„</button>
        <button id="btn-forgot" class="btn-outline" style="color: var(--danger); border-color: var(--danger);" disabled>å¿˜ã‚ŒãŸ</button>
      </div>
    </div>

    <p id="remaining-count" style="text-align:center; font-size:12px; color:var(--subtext); margin-top:15px;"></p>
  </div>

  <div id="empty-ui" class="hidden status-msg">
    <div class="text-large">ğŸ‰ Clear!</div>
    <p>ç¾åœ¨,å¼±ç‚¹å˜èªã¯ã‚ã‚Šã¾ã›ã‚“.</p>
    <button class="btn-primary mt-20" onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã¸æˆ»ã‚‹</button>
  </div>
</div>

<script src="data.js"></script>
<script src="srs.js"></script>

<script>
let weakQueue = [];
let current = null;
let isRevealed = false;

// ç›´è¿‘ã«å‡ºã—ãŸå˜èªã‚’é¿ã‘ã‚‹(weakãƒ¢ãƒ¼ãƒ‰å°‚ç”¨)
const RECENT_KEY = "toeic_weak_recent";
function getRecent() {
  try { return JSON.parse(localStorage.getItem(RECENT_KEY) || "[]"); } catch { return []; }
}
function pushRecent(id) {
  const MAX = 20;
  const arr = getRecent().filter(x => x !== id);
  arr.unshift(id);
  if (arr.length > MAX) arr.length = MAX;
  localStorage.setItem(RECENT_KEY, JSON.stringify(arr));
}

const dom = {
  card: document.getElementById('card'),
  word: document.getElementById('word'),
  answer: document.getElementById('answer-section'),
  meaning: document.getElementById('meaning'),
  example: document.getElementById('example'),
  hint: document.getElementById('tap-hint'),
  remaining: document.getElementById('remaining-count'),
  learningUI: document.getElementById('learning-ui'),
  emptyUI: document.getElementById('empty-ui'),
  btnKnown: document.getElementById('btn-known'),
  btnUnsure: document.getElementById('btn-unsure'),
  btnForgot: document.getElementById('btn-forgot'),
};

function setButtons(on) {
  dom.btnKnown.disabled = !on;
  dom.btnUnsure.disabled = !on;
  dom.btnForgot.disabled = !on;
}

// å¼±ç‚¹ã‚¹ã‚³ã‚¢: é«˜ã„ã»ã©å„ªå…ˆ
// - æ­£ç­”ç‡ãŒä½ã„ã»ã©
// - wrong ãŒå¤šã„ã»ã©
// - ç›´è¿‘ã§é–“é•ãˆãŸã»ã©
function weakScore(s) {
  const total = (s.correct || 0) + (s.wrong || 0);
  if (total <= 0) return -1;

  const acc = (s.correct || 0) / total;          // 0..1
  const wrong = (s.wrong || 0);                  // 0..
  const now = Date.now();
  const lastAt = (s.lastAt || 0);
  const days = Math.max(0, (now - lastAt) / (24*60*60*1000));
  const recency = 1 / (1 + days);                // æœ€è¿‘ã»ã© 1 ã«è¿‘ã„

  // é‡ã¿: accä½ + wrongå¤š + æœ€è¿‘å¾©ç¿’ã»ã©å„ªå…ˆ
  return (1 - acc) * 2.0 + Math.log1p(wrong) * 1.2 + recency * 0.8;
}

function shuffleInPlace(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
}

// å¼±ç‚¹ã‚­ãƒ¥ãƒ¼ã‚’ä½œã‚‹
function buildWeakQueue() {
  const stats = SRS.getStats();
  const recent = new Set(getRecent());

  // ã¾ãšå¼±ç‚¹å€™è£œã‚’å…¨ä»¶é›†ã‚ã‚‹
  let candidates = wordData
    .map(w => {
      const s = stats[w.id];
      if (!s) return null;
      const total = (s.correct || 0) + (s.wrong || 0);
      if (total <= 0) return null;

      // å¼±ç‚¹åˆ¤å®šã¯ç·©ã‚ã‚‹: acc<0.8 ã‹ wrong>=2 ã‹ ç›´è¿‘ã«é–“é•ãˆãŸ
      const acc = (s.correct || 0) / total;
      const recentlyWrong = (s.wrong || 0) > 0 && (Date.now() - (s.lastAt || 0) < 7 * 24*60*60*1000);
      const isWeak = (acc < 0.8) || ((s.wrong || 0) >= 2) || recentlyWrong;
      if (!isWeak) return null;

      return { w, score: weakScore(s), avoid: recent.has(w.id) };
    })
    .filter(Boolean);

  if (candidates.length === 0) {
    weakQueue = [];
    return;
  }

  // ç›´è¿‘å‡ºã—ãŸã‚„ã¤ã‚’ãªã‚‹ã¹ãå¾Œå›ã—
  const fresh = candidates.filter(x => !x.avoid);
  const avoided = candidates.filter(x => x.avoid);

  // ã‚¹ã‚³ã‚¢é †ã«ä¸Šä½ã‚’å–ã‚Šã¤ã¤,å°‘ã—ãƒ©ãƒ³ãƒ€ãƒ æ€§ã‚’å…¥ã‚Œã‚‹
  fresh.sort((a,b) => b.score - a.score);
  avoided.sort((a,b) => b.score - a.score);

  // ä¸Šä½ã‚’ä¸­å¿ƒã«ã‚­ãƒ¥ãƒ¼åŒ–
  const takeFresh = fresh.slice(0, 40);
  const takeAvoid = avoided.slice(0, 15);

  // åŒç‚¹ã‚„å›ºå®šåŒ–ã‚’é¿ã‘ã‚‹ãŸã‚è»½ãã‚·ãƒ£ãƒƒãƒ•ãƒ«
  shuffleInPlace(takeFresh);
  shuffleInPlace(takeAvoid);

  // ãŸã ã—å…ˆé ­ã¯å¼·ã„å¼±ç‚¹ã‚’å„ªå…ˆã—ãŸã„ã®ã§,å…ˆé ­ã ã‘å†ã‚½ãƒ¼ãƒˆ
  takeFresh.sort((a,b) => b.score - a.score);

  weakQueue = takeFresh.concat(takeAvoid).map(x => x.w);

  // ã“ã“ã§æœ€ä½ã§ã‚‚æ•°å€‹ã¯ç¢ºä¿
  if (weakQueue.length === 0) weakQueue = candidates.map(x => x.w);
}

function showEmpty() {
  dom.learningUI.classList.add('hidden');
  dom.emptyUI.classList.remove('hidden');
}

function loadNext() {
  if (!weakQueue.length) {
    showEmpty();
    return;
  }

  // ç›´å‰ã¨åŒã˜ãŒå‡ºãŸã‚‰é¿ã‘ã‚‹(å¯èƒ½ãªã‚‰)
  let next = weakQueue.shift();
  if (current && next && next.id === current.id) {
    const altIndex = weakQueue.findIndex(x => x.id !== current.id);
    if (altIndex >= 0) {
      const alt = weakQueue.splice(altIndex, 1)[0];
      weakQueue.unshift(next);
      next = alt;
    }
  }

  current = next;
  isRevealed = false;

  dom.word.innerText = current.word;
  dom.meaning.innerText = current.meaning;
  dom.example.innerText = current.example;

  dom.answer.classList.add('hidden');
  dom.hint.classList.remove('hidden');
  setButtons(false);

  dom.remaining.innerText = "æ®‹ã‚Š " + weakQueue.length + " å˜èª";
  pushRecent(current.id);
}

function reveal() {
  if (!current || isRevealed) return;
  isRevealed = true;
  dom.answer.classList.remove('hidden');
  dom.hint.classList.add('hidden');
  setButtons(true);
}

function handleAnswer(isCorrect) {
  if (!current || !isRevealed) return;

  // Weakãƒ¢ãƒ¼ãƒ‰ã¯,æ€ªã—ã„/å¿˜ã‚ŒãŸã‚’å¼·ãå†ç™»å ´ã•ã›ãŸã„ã®ã§
  // isCorrect=false ã®æ™‚ã¯,åŒã˜å˜èªã‚’ã‚­ãƒ¥ãƒ¼ã®å¾Œæ–¹ã«æˆ»ã™(ãŸã ã—é€£ç™ºã¯ã—ãªã„)
  SRS.recordResult(current.id, isCorrect);

  if (!isCorrect) {
    // ã‚­ãƒ¥ãƒ¼å¾Œæ–¹ã«æˆ»ã™(ã™ãã¯å‡ºãªã„)
    weakQueue.push(current);
  }

  // çŠ¶æ…‹æ›´æ–°
  buildWeakQueue();
  loadNext();
}

dom.card.addEventListener('click', reveal);
dom.btnKnown.onclick = () => handleAnswer(true);
dom.btnUnsure.onclick = () => handleAnswer(false);
dom.btnForgot.onclick = () => handleAnswer(false);

window.onload = function() {
  buildWeakQueue();
  loadNext();
};
</script>

</body>
</html>