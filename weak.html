<script>
let weakPool = [];
let current = null;
let isRevealed = false;

const RECENT_MAX = 12; // 直近回避数
const RECENT_KEY = "toeic_weak_recent";

const dom = {
  card: document.getElementById('card'),
  word: document.getElementById('word'),
  answer: document.getElementById('answer-section'),
  meaning: document.getElementById('meaning'),
  example: document.getElementById('example'),
  hint: document.getElementById('tap-hint'),
  remaining: document.getElementById('remaining-count'),
  learningUI: document.getElementById('learning-ui'),
  emptyUI: document.getElementById('empty-ui'),
  btnKnown: document.getElementById('btn-known'),
  btnUnsure: document.getElementById('btn-unsure'),
  btnForgot: document.getElementById('btn-forgot')
};

function setButtons(on) {
  dom.btnKnown.disabled = !on;
  dom.btnUnsure.disabled = !on;
  dom.btnForgot.disabled = !on;
}

function getRecent() {
  try { return JSON.parse(localStorage.getItem(RECENT_KEY) || "[]"); }
  catch { return []; }
}
function pushRecent(id) {
  const arr = getRecent().filter(x => x !== id);
  arr.unshift(id);
  if (arr.length > RECENT_MAX) arr.length = RECENT_MAX;
  localStorage.setItem(RECENT_KEY, JSON.stringify(arr));
}

function isWeakWord(w, stats) {
  const s = stats[w.id];
  if (!s) return false;
  const total = (s.correct || 0) + (s.wrong || 0);
  if (total <= 0) return false;
  const acc = (s.correct || 0) / total;
  return acc < 0.7;
}

function rebuildWeakPool() {
  const stats = SRS.getStats();
  weakPool = wordData.filter(w => isWeakWord(w, stats));
}

function pickNextWeak() {
  const recent = new Set(getRecent());
  if (current) recent.add(current.id); // 直前の完全回避

  // まずは直近回避ありで候補を作る
  let candidates = weakPool.filter(w => !recent.has(w.id));

  // 候補が空なら直近回避を緩める
  if (candidates.length === 0) {
    candidates = weakPool.filter(w => !current || w.id !== current.id);
  }

  if (candidates.length === 0) return null;

  return candidates[Math.floor(Math.random() * candidates.length)];
}

function renderWord(w) {
  current = w;
  isRevealed = false;

  dom.word.innerText = w.word;
  dom.meaning.innerText = w.meaning;
  dom.example.innerText = w.example;

  dom.answer.classList.add('hidden');
  dom.hint.classList.remove('hidden');
  setButtons(false);

  dom.remaining.innerText = "残り " + weakPool.length + " 単語";
}

function loadNext() {
  rebuildWeakPool();

  if (weakPool.length === 0) {
    dom.learningUI.classList.add('hidden');
    dom.emptyUI.classList.remove('hidden');
    return;
  }

  const next = pickNextWeak();
  if (!next) {
    dom.learningUI.classList.add('hidden');
    dom.emptyUI.classList.remove('hidden');
    return;
  }

  pushRecent(next.id);
  renderWord(next);
}

function reveal() {
  if (!current || isRevealed) return;
  isRevealed = true;
  dom.answer.classList.remove('hidden');
  dom.hint.classList.add('hidden');
  setButtons(true);
}

function handleAnswer(isCorrect) {
  if (!current || !isRevealed) return;
  SRS.recordResult(current.id, isCorrect);
  loadNext();
}

dom.card.addEventListener('click', reveal);

dom.btnKnown.onclick = () => handleAnswer(true);
dom.btnUnsure.onclick = () => handleAnswer(false);
dom.btnForgot.onclick = () => handleAnswer(false);

window.onload = () => {
  loadNext();
};
</script>